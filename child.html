<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>GAS RPC POC - Full Device Client</title>

    <!-- Bootstrap -->
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <style>
        body { padding: 20px; }
        pre { background: #f3f3f3; padding: 10px; }
    </style>

    <script>
        let parentOrigin = null;
        let connected = false;

        // ----------------------------------------------
        // EARLY MESSAGE LISTENER (fixes handshake races)
        // ----------------------------------------------
        window.addEventListener("message", (event) => {
            const msg = event.data;
            log("Received message: " + JSON.stringify(msg));

            // HANDSHAKE FROM GAS WRAPPER
            if (msg.type === "parent-init") {
                parentOrigin = event.origin;
                connected = true;

                // acknowledge handshake
                window.parent.postMessage(
                    { type: "child-ready" },
                    parentOrigin
                );

                log("Parent connection established, origin=" + parentOrigin);
                return;
            }

            // RPC RESPONSE
            if (msg.type === "gas-response") {
                log("[GAS RESPONSE] " + JSON.stringify(msg));
                return;
            }
        });

        // ----------------------------------------------
        // ANNOUNCE CHILDS PRESENCE ASAP
        // ----------------------------------------------
        window.addEventListener("load", () => {
            window.parent.postMessage(
                { type: "child-hello" },
                "*"
            );
        });

        // ----------------------------------------------
        // UTIL LOGGING
        // ----------------------------------------------
        function log(...args) {
            const out = document.getElementById("log");
            out.innerText += args.map(a => typeof a === "string" ? a : JSON.stringify(a)).join(" ") + "\n";
        }

        // ----------------------------------------------
        // SEND DEVICE EVENTS TO GAS PARENT
        // ----------------------------------------------
        function sendDeviceEvent(kind, data, meta={}) {
            if (!connected) return alert("Parent not connected yet!");

            window.parent.postMessage({
                type: "device-event",
                payload: { kind, data, meta }
            }, parentOrigin);

            log(`[DEVICE EVENT SENT] kind=${kind}`);
        }

        // ----------------------------------------------
        // CAMERA SNAPSHOT
        // ----------------------------------------------
        async function captureCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const track = stream.getVideoTracks()[0];
                const capture = new ImageCapture(track);
                const bitmap = await capture.grabFrame();

                const canvas = document.createElement("canvas");
                canvas.width = bitmap.width;
                canvas.height = bitmap.height;

                const ctx = canvas.getContext("2d");
                ctx.drawImage(bitmap, 0, 0);

                const dataUrl = canvas.toDataURL("image/png");

                sendDeviceEvent("camera", dataUrl, {
                    width: bitmap.width,
                    height: bitmap.height
                });

                stream.getTracks().forEach(t => t.stop());

            } catch (err) {
                log("Camera error: " + err);
            }
        }

        // ----------------------------------------------
        // GEOLOCATION
        // ----------------------------------------------
        function sendLocation() {
            navigator.geolocation.getCurrentPosition((pos) => {
                sendDeviceEvent("location", {
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude,
                    accuracy: pos.coords.accuracy
                });
            }, (err) => {
                log("Location error: " + err.message);
            });
        }

        // ----------------------------------------------
        // FILE PICKER
        // ----------------------------------------------
        function pickFile() {
            const input = document.createElement("input");
            input.type = "file";

            input.onchange = () => {
                const file = input.files[0];
                const reader = new FileReader();

                reader.onload = () => {
                    sendDeviceEvent("file", reader.result, {
                        name: file.name,
                        size: file.size,
                        mime: file.type
                    });
                };

                reader.readAsDataURL(file);
            };

            input.click();
        }

        // ----------------------------------------------
        // MICROPHONE (record 3 seconds)
        // ----------------------------------------------
        async function recordAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const recorder = new MediaRecorder(stream);

                const chunks = [];
                recorder.ondataavailable = e => chunks.push(e.data);

                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: "audio/webm" });
                    const reader = new FileReader();

                    reader.onloadend = () => {
                        sendDeviceEvent("mic", reader.result, {
                            duration_sec: 3
                        });
                    };

                    reader.readAsDataURL(blob);
                };

                recorder.start();
                log("Recording audio for 3 seconds...");
                setTimeout(() => recorder.stop(), 3000);

            } catch (err) {
                log("Microphone error: " + err);
            }
        }

        // ----------------------------------------------
        // RPC: REQUEST TEMPERATURE USING LAT/LNG
        // ----------------------------------------------
        function requestTemperature() {
            navigator.geolocation.getCurrentPosition((pos) => {
                const requestId = Date.now().toString();

                window.parent.postMessage({
                    type: "flutter-request",
                    requestId,
                    payload: {
                        action: "temperature",
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude
                    }
                }, parentOrigin);

                log("Temperature request sent.");

            }, (err) => {
                alert("Location required for temperature lookup: " + err.message);
            });
        }
    </script>
</head>

<body class="container">

    <h2>GAS RPC POC — Full Device API Client</h2>
    <p>Running inside GitHub Pages → inside GAS iframe</p>

    <button class="btn btn-primary mb-2" onclick="requestTemperature()">Get Temperature</button><br>
    <button class="btn btn-secondary mb-2" onclick="captureCamera()">Capture Camera</button><br>
    <button class="btn btn-secondary mb-2" onclick="sendLocation()">Send Location</button><br>
    <button class="btn btn-secondary mb-2" onclick="pickFile()">Pick File</button><br>
    <button class="btn btn-secondary mb-2" onclick="recordAudio()">Record Audio (3s)</button><br>

    <hr>
    <h5>Console Log</h5>
    <pre id="log"></pre>

</body>
</html>
