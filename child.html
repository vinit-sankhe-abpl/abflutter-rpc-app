<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>GAS RPC POC - Simple Client</title>

    <!-- Bootstrap -->
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <style>
        body { padding: 20px; }
        pre { background: #f3f3f3; padding: 10px; }
    </style>

    <script>
        let parentOrigin = null;

        // -------------------------------
        // RECEIVE HANDSHAKE FROM GAS PARENT
        // -------------------------------
        window.addEventListener("message", (event) => {
            const msg = event.data;

            // GAS parent tells us its origin
            if (msg.type === "parent-init") {
                parentOrigin = event.origin;
                log("Parent initialized: " + parentOrigin);
                return;
            }

            // GAS RPC response
            if (msg.type === "gas-response") {
                log("RPC Response:", msg);
                return;
            }
        });

		// -------------------------------
		// SEND RPC TO GAS PARENT (Dynamic lat/lng)
		// -------------------------------
		function requestTemperature() {
			// 1. Capture current device location
			navigator.geolocation.getCurrentPosition((pos) => {
				const lat = pos.coords.latitude;
				const lng = pos.coords.longitude;

				const requestId = Date.now().toString();
				
				log(`Sending temperature request (lat=${lat}, lng=${lng}), reqId=${requestId}`);
				
				if (!parentOrigin) throw new Error("Parent not ready");

				// 2. Send RPC to GAS parent with lat/lng
				window.parent.postMessage({
					type: "flutter-request",   // GAS wrapper expects this
					requestId: requestId,
					payload: {
						action: "temperature",
						lat: lat,
						lng: lng
					}
				}, parentOrigin);

				log(`Sent temperature request successfully!`);

			}, (error) => {
				log("Geolocation error: " + error.message);
				alert("Unable to fetch / post location or location permission denied.");
			});
		}

        // -------------------------------
        // DEVICE EVENTS → GAS
        // -------------------------------
        function sendDeviceEvent(kind, data, meta={}) {
            if (!parentOrigin) return alert("Parent not ready");

            window.parent.postMessage({
                type: "device-event",
                payload: {
                    kind,
                    data,
                    meta
                }
            }, parentOrigin);

            log("Device event sent:", {kind, meta});
        }

        // CAMERA (simple — stops at grabFrame())
        async function captureCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia(
                    { video: true, audio: false }
                );

                const track = stream.getVideoTracks()[0];
                const imageCapture = new ImageCapture(track);
                const bitmap = await imageCapture.grabFrame();

                // Draw to canvas → base64
                const canvas = document.createElement("canvas");
                canvas.width = bitmap.width;
                canvas.height = bitmap.height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(bitmap, 0, 0);
                const dataUrl = canvas.toDataURL("image/png");

                sendDeviceEvent("camera", dataUrl, {width: bitmap.width, height: bitmap.height});
                stream.getTracks().forEach(t => t.stop());
            } catch (err) {
                log("Camera error:", err);
            }
        }

        // LOCATION
        function sendLocation() {
            navigator.geolocation.getCurrentPosition((pos) => {
                sendDeviceEvent("location", {
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude,
                    accuracy: pos.coords.accuracy
                });
            }, (err) => {
                log("Location error:", err);
            });
        }

        // FILE PICKER
        function pickFile() {
            const input = document.createElement("input");
            input.type = "file";
            input.onchange = async () => {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = () => {
                    sendDeviceEvent("file", reader.result, {
                        name: file.name,
                        size: file.size,
                        type: file.type
                    });
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        // MICROPHONE — record 3 seconds
        async function recordAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({audio: true});
                const mediaRecorder = new MediaRecorder(stream);

                const chunks = [];
                mediaRecorder.ondataavailable = e => chunks.push(e.data);

                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, {type: "audio/webm"});
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        sendDeviceEvent("mic", reader.result, {duration_sec: 3});
                    };
                    reader.readAsDataURL(blob);
                };

                mediaRecorder.start();
                log("Recording 3 seconds...");
                setTimeout(() => mediaRecorder.stop(), 3000);

            } catch (err) {
                log("Mic error:", err);
            }
        }

        // Utility log
        function log(...args) {
            const out = document.getElementById("log");
            out.innerText += args.map(a => typeof a === "string" ? a : JSON.stringify(a)).join(" ") + "\n";
        }
    </script>
</head>

<body class="container">

    <h2>GAS RPC POC — Plain HTML Client</h2>
    <p>This page runs in GitHub Pages → loaded inside GAS wrapper iframe → communicates via postMessage.</p>

    <hr>

    <button class="btn btn-primary mb-2" onclick="requestTemperature()">Fetch Temperature</button>
    <br>

    <button class="btn btn-secondary mb-2" onclick="captureCamera()">Capture Camera Image</button><br>
    <button class="btn btn-secondary mb-2" onclick="sendLocation()">Send Location</button><br>
    <button class="btn btn-secondary mb-2" onclick="pickFile()">Pick File</button><br>
    <button class="btn btn-secondary mb-2" onclick="recordAudio()">Record 3s Audio</button><br>

    <hr>
    <h5>Console Log</h5>
    <pre id="log"></pre>

</body>
</html>
