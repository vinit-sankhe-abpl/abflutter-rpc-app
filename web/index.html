<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="abflutter_rpc_app">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>abflutter_rpc_app</title>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <script>
      // CAMERA: capture single PNG frame and return DataURL
      window.rpcCaptureCamera = async function () {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const track = stream.getVideoTracks()[0];

        if (!('ImageCapture' in window)) {
          const video = document.createElement('video');
          video.srcObject = stream;
          await video.play();

          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0);
          const dataUrl = canvas.toDataURL('image/png');

          stream.getTracks().forEach(t => t.stop());
          return dataUrl;
        }

        const capture = new ImageCapture(track);
        const bitmap = await capture.grabFrame();

        const canvas = document.createElement('canvas');
        canvas.width = bitmap.width;
        canvas.height = bitmap.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(bitmap, 0, 0);

        const dataUrl = canvas.toDataURL('image/png');
        stream.getTracks().forEach(t => t.stop());
        return dataUrl;
      };

      // MICROPHONE: record ~3 seconds of audio and return DataURL (audio/webm)
      window.rpcRecordAudio = async function (durationMs = 3000) {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const recorder = new MediaRecorder(stream);
        const chunks = [];

        return await new Promise((resolve, reject) => {
          recorder.ondataavailable = (e) => {
            if (e.data && e.data.size > 0) {
              chunks.push(e.data);
            }
          };

          recorder.onerror = (e) => {
            stream.getTracks().forEach(t => t.stop());
            reject(e.error || new Error('MediaRecorder error'));
          };

          recorder.onstop = async () => {
            try {
              const blob = new Blob(chunks, { type: 'audio/webm' });
              const reader = new FileReader();
              reader.onloadend = () => {
                stream.getTracks().forEach(t => t.stop());
                resolve(reader.result); // DataURL
              };
              reader.readAsDataURL(blob);
            } catch (err) {
              stream.getTracks().forEach(t => t.stop());
              reject(err);
            }
          };

          recorder.start();
          setTimeout(() => {
            if (recorder.state !== 'inactive') {
              recorder.stop();
            }
          }, durationMs);
        });
      };
    </script>
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>
